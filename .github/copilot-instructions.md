# AI Coding Agent Guidelines for 360_Viewer
- **Repository Layout**: Two actively maintained packages share the root. `backend/` (`server.js`) exposes the API and serves the built UI; `pano-viewer/` is a CRA React app that consumes those APIs and renders the 360° viewer via `react-photo-sphere-viewer` + plugins.
- **Environment & Secrets**: Copy `backend/.env.example` to `.env`. `MONGODB_URI`, `AWS_REGION`, `S3_BUCKET_NAME`, and AWS credentials must be populated before uploads work. `CLIENT_ORIGIN` controls CORS; leave comma-separated domains without trailing slashes. `REACT_APP_API_BASE_URL` is read by the frontend when it is built through the backend.
- **Development Workflow**: Preferred startup is `start-dev.bat`, which spawns `backend:npm run dev` (nodemon) and `pano-viewer:npm start`. On non-Windows shells run each command manually from its package. Backend listens on `http://localhost:5000`, frontend on `http://localhost:3000` during dev.
- **Build & Deploy**: Production is a single Express process—run `pano-viewer/npm run build` then `backend/npm start`. The backend serves `pano-viewer/build` and proxies all non-`/api` routes to `index.html`; keep new API endpoints under `/api` to avoid routing conflicts.
- **Data Model**: Projects (`backend/models/Project.js`) own many panophotos (`backend/models/Panophoto.js`). Projects maintain `levels` (ordered floor plans with optional background S3 assets) and a `startPanophoto`. Panophotos store `xPosition`/`yPosition` normalized to `[0,1]`, `levelId`, and S3 metadata (`imageUrl`, `thumbnailUrl`, `s3Key`).
- **Level Management**: `ensureProjectLevels` (`backend/utils/projectLevels.js`) normalizes level ordering, names, and ensures Level 1 mirrors `canvasBackgroundImage*`. Any mutation to `project.levels` should go through this helper to keep indices stable.
- **Linking Contract**: `linkedPhotos` is an array of `{ target, azimuth, azimuthOffset }`. `PATCH /api/panophotos/:id/link|unlink` in `backend/routes/panophotos.js` enforces bidirectional updates and normalizes legacy entries. When adjusting links manually, preserve `$addToSet`/`$pull` symmetry and never rewrite stored `azimuthOffset`—it comes from editor fine-tuning.
- **Azimuth Math**: `calculateAzimuthDegrees` computes bearings from stored canvas coordinates. Updates to `xPosition`/`yPosition` or `levelId` trigger `recalculateLinkAzimuths`, which recomputes bearings for neighbors; ensure new spatial logic keeps positions normalized so this math stays valid.
- **Uploads & Storage**: `POST /api/panophotos` uses in-memory `multer`, slugified file names, and deterministic S3 keys (`panophotos/${projectSlug}_...`). Failures should cleanly surface 4xx/5xx JSON. Deletion removes the S3 object and unlinks neighbors before pruning the Mongo record.
- **Project Lifecycle**: Creating a project deactivates previous ones and marks the new one active. `ensureProjectStartPanophoto` picks the oldest photo if the chosen start scene is missing; deletions fall back the same way. Setting start scenes happens via `PATCH /api/projects/:id/start`.
- **Background Assets**: `PATCH /api/projects/:id/background` uploads level background images to S3 with keys under `project-level-backgrounds/`. Level 0 background also syncs to `canvasBackgroundImage*`. Cleanups remove previous keys if uploads succeed.
- **Frontend Data Fetching**: Components use vanilla `fetch` with `credentials: 'include'` and attempt `response.json()` then fallback to `.text()` for error messaging. Mirror this pattern whenever adding API calls to keep toast/status handling consistent.
- **Project Editor**: `pano-viewer/src/Pages/ProjectEditor.js` orchestrates placement, linking, and level management. It multiplies stored positions by 100 for SVG overlays, relies on `normalizeId` helpers to cope with ObjectId shapes, and batches updates back to `/api/panophotos` and `/api/projects`. Keep `dragStateRef` + pointer handlers intact when extending canvas interactions.
- **Viewer Routing & Markers**: `pano-viewer/src/Components/Panoviewer.js` prioritizes `state.panophotoId` and `?id=` when loading scenes, then falls back to `?src=`/`testPanorama.jpg`. Markers derive from `linkedPhotos` and keep yaw as `(azimuth + azimuthOffset)`. Always navigate via `navigate('/viewer?id=...',{ state:{ panophotoId } })` so subsequent loads pull fresh metadata.
- **React Conventions**: Components are functional, stateful via hooks, and colocate shared styles in `src/CSS/styles.css`. `resolutions.three` in `pano-viewer/package.json` pins Three.js for the viewer—update both the dependency and resolution together to avoid plugin regressions.
- **Error & Status Handling**: Backend returns JSON `{ message }` on failure; frontend stores those in `statusMessage`. Preserve this contract so UI banners and console logs remain meaningful.
- **Testing Reality**: No automated tests exist today; manual verification means hitting API endpoints via the editor or viewer. When adding riskier backend logic, consider ad-hoc scripts under `backend/` or temporary endpoints, then remove them once verified.

Feel free to iterate on these notes—flag unclear sections so we can refine them.
